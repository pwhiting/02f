#!/usr/bin/perl
use OracleXML;
use Policy;
use strict;
use Data::Dumper::Concise;

use JSON::MaybeXS ();


my $json = JSON::MaybeXS->new(utf8 => 1, pretty => 1, sort_by => 1);



my $merged_policies={};
foreach my $file (@ARGV) {
  warn "processing $file\n";
  my $oracle=OracleXML->new($file);
  foreach my $policy (@{$oracle->GetPolicies}) {
    my $filter=$policy->Filter;
    if(not defined $merged_policies->{$filter}) {
        $merged_policies->{$filter}=$policy;
    } else {
       $merged_policies->{$filter}->Merge($policy);
    }
  }
}


foreach my $name (keys $merged_policies) {
  my $policy=$merged_policies->{$name};
  my $jconfig = {
    active              => JSON::MaybeXS::true,
    description         => "AutoGenerated",
    applicationName     => "iPlanetAMWebAgentService",
    resourceTypeUuid    => "feb3490d-5f5e-4413-ace8-b76ad5bdf172",
    name                => $policy->FilterName,
    resources           => [sort(@{$policy->Resources})],
    subject             => $policy->Subjects,
    condition           => $policy->Conditions,
    actionValues        => $policy->ActionValues,
    resourceAttributes  => $policy->ResourceAttributes,
  };
  print $json->encode($jconfig);
}
