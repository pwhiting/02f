#!/usr/bin/perl
use JSON::MaybeXS ();
use OracleXML;
use Policy;
use strict;
use Data::Dumper::Concise;

my $json = JSON::MaybeXS->new(utf8 => 1, pretty => 1, sort_by => 1);

foreach my $file (@ARGV) {
  warn "processing $file\n";
  my $oracle=OracleXML->new($file);
  foreach my $policy (@{$oracle->GetPolicies}) {
    my $jconfig = {
      active              => JSON::MaybeXS::true,
      description         => "AutoGenerated",
      applicationName     => "iPlanetAMWebAgentService",
      resourceTypeUuid    => "feb3490d-5f5e-4413-ace8-b76ad5bdf172",
      name                => $policy->Path,
      resources           => $policy->Resources,
      subject             => $policy->Subjects,
      condition           => $policy->Conditions,
      actionValues        => $policy->ActionValues,
      resourceAttributes  => $policy->ResourceAttributes,
    };

    map {delete $jconfig->{$_} if not $jconfig->{$_};} $jconfig;
    $jconfig->{description}='';
    open my $fh,">","json/".$policy->Path.".json";
    #print $json->encode($jconfig);
    print $fh $json->encode($jconfig);
    close $fh;
  }
}

__END__
